<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.25" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const useChoice = localStorage.getItem('vuepress-color-scheme')
      const systemStatus =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (useChoice === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (useChoice === 'dark' || systemStatus) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><title>Vite 原理浅析及应用 | 离殊的博客</title><meta name="description" content="离殊的博客">
    <link rel="preload" href="/assets/style-DX_uggt_.css" as="style"><link rel="stylesheet" href="/assets/style-DX_uggt_.css">
    <link rel="modulepreload" href="/assets/app-igEGucXV.js"><link rel="modulepreload" href="/assets/index.html-kK6qt4Vj.js">
    <link rel="prefetch" href="/assets/index.html-Bq-IpbT_.js" as="script"><link rel="prefetch" href="/assets/index.html-Ctkgkotr.js" as="script"><link rel="prefetch" href="/assets/index.html-BvvSJzCk.js" as="script"><link rel="prefetch" href="/assets/index.html-COyCXRQ8.js" as="script"><link rel="prefetch" href="/assets/index.html-Dg4J3gQH.js" as="script"><link rel="prefetch" href="/assets/index.html-BDXRmSue.js" as="script"><link rel="prefetch" href="/assets/index.html-BnzNag6p.js" as="script"><link rel="prefetch" href="/assets/index.html-Cgxb9UVq.js" as="script"><link rel="prefetch" href="/assets/index.html-fC3HOxfC.js" as="script"><link rel="prefetch" href="/assets/index.html-BE3s2cNu.js" as="script"><link rel="prefetch" href="/assets/index.html-B_3FPNY8.js" as="script"><link rel="prefetch" href="/assets/index.html-BdW98VTy.js" as="script"><link rel="prefetch" href="/assets/index.html-DImDCflB.js" as="script"><link rel="prefetch" href="/assets/index.html-QPrbtHf5.js" as="script"><link rel="prefetch" href="/assets/index.html-jRQzdyvr.js" as="script"><link rel="prefetch" href="/assets/index.html-DfpEmwHX.js" as="script"><link rel="prefetch" href="/assets/index.html-C8JPwFOC.js" as="script"><link rel="prefetch" href="/assets/index.html-DWfP8_UO.js" as="script"><link rel="prefetch" href="/assets/index.html-4WhGFOh_.js" as="script"><link rel="prefetch" href="/assets/index.html-CO_O86Zk.js" as="script"><link rel="prefetch" href="/assets/index.html-DcJiGjbp.js" as="script"><link rel="prefetch" href="/assets/index.html-mEfs6vOG.js" as="script"><link rel="prefetch" href="/assets/index.html-DYBOplpI.js" as="script"><link rel="prefetch" href="/assets/index.html-Zz-84VPm.js" as="script"><link rel="prefetch" href="/assets/index.html-BbtX7JTg.js" as="script"><link rel="prefetch" href="/assets/index.html-8JYUwZWm.js" as="script"><link rel="prefetch" href="/assets/index.html-CJT5Me-F.js" as="script"><link rel="prefetch" href="/assets/index.html-DPqq69PO.js" as="script"><link rel="prefetch" href="/assets/404.html-BkO9hCrg.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container no-sidebar external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/"><!----><span class="vp-site-name" aria-hidden="true">离殊的博客</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/" aria-label="Home"><!--[--><!--[--><!--]--><!--]-->Home<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/posts/" aria-label="Posts"><!--[--><!--[--><!--]--><!--]-->Posts<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/tags/" aria-label="Tags"><!--[--><!--[--><!--]--><!--]-->Tags<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/links/" aria-label="Links"><!--[--><!--[--><!--]--><!--]-->Links<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="auto-link external-link" href="https://github.com/0xe69e97" aria-label="Github" rel="noopener noreferrer" target="_blank"><!--[--><!--[--><!--]--><!--]-->Github<!--[--><!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/" aria-label="Home"><!--[--><!--[--><!--]--><!--]-->Home<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/posts/" aria-label="Posts"><!--[--><!--[--><!--]--><!--]-->Posts<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/tags/" aria-label="Tags"><!--[--><!--[--><!--]--><!--]-->Tags<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/links/" aria-label="Links"><!--[--><!--[--><!--]--><!--]-->Links<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="auto-link external-link" href="https://github.com/0xe69e97" aria-label="Github" rel="noopener noreferrer" target="_blank"><!--[--><!--[--><!--]--><!--]-->Github<!--[--><!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><!----><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div vp-content><!--[--><!--]--><div id="content"><h2 id="前言" tabindex="-1"><a class="header-anchor" href="#前言"><span>前言</span></a></h2><p>Tips: 如果大家想直接看重点可以跳过前言，这里将介绍一下为什么我会有这次分享，也就是本次分享的背景以及目的。</p><p>为了方便大家快速寻找到自己需要的知识点，列出以下大纲</p><ul><li><a href="#%E5%89%8D%E8%A8%80">前言</a></li><li><a href="#%E4%B8%8B%E4%B8%80%E4%BB%A3%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91%E4%B8%8E%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7">什么是 Vite ?</a></li><li><a href="#esm-ecmascript-modules">Vite 原理浅析</a></li><li><a href="#webpack-%E5%8D%87%E7%BA%A7-vite">Vite 应用及实践</a></li><li><a href="#%E4%B8%AA%E4%BA%BA%E5%AF%B9-vite-%E7%9A%84%E4%B8%80%E4%BA%9B%E6%83%B3%E6%B3%95">个人对 Vite 的一些想法</a></li></ul><h3 id="背景" tabindex="-1"><a class="header-anchor" href="#背景"><span>背景</span></a></h3><p>本次的分享仅限于参考，学习，并不保证在前端高速发展，日新月异的情况下有没有过时。如有不对的点欢迎各位大佬指出，有什么不足的地方也请大家担待。只是一些实践过后的想法和总结，拿出来分享一下，欢迎探讨。</p><ul><li>19 年想法，20 年实现，21 年可用于生产</li><li>解决开发痛点</li><li>实践并应用于项目</li></ul><h4 id="想法-实现-生产" tabindex="-1"><a class="header-anchor" href="#想法-实现-生产"><span>想法 =&gt; 实现 =&gt; 生产</span></a></h4><p>尤大在 19 年就已经有了 Vite 的想法，只不过那个时候还在忙 Vue3 的重构，并没有太多的时间来具体实现，之后 Vue3 几乎成型后，尤大也就开始研究 Vite 的开发了，在 20 年的时候就发了微博、知乎、推特等社交账号说明，并将源码上传至 Github 。</p><p>到目前为止（2021 年 08 月），Vite 已经完全可以用于生产环境，已经成熟。</p><h4 id="解决开发痛点" tabindex="-1"><a class="header-anchor" href="#解决开发痛点"><span>解决开发痛点</span></a></h4><p>本次升级 <code>Vite</code> 的最初的目的就是要改善开发的痛点，那么我们系统的痛点是什么呢？</p><p><code>HMR</code>，好，什么是 HMR？就是我们在开发过程中代码的热更新。为什么说这个是开发时候的痛点呢？</p><p>举个例子：</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// ...</span></span>
<span class="line"><span class="token comment">// 打印一些变量</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>variable<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// ...</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如上，我修改项目中一处代码，保存后。页面将在 <strong>6s</strong> 后给我反馈。。也就是说，无论我改了什么代码？什么内容，只要触发了热更新，我将浪费 <strong>6s</strong> 的时间去等待。久而久之......人生有多少个 6s ？</p><p>好，这就是为什么我要解决这个问题的点。我先说一下目前升级前后的对比数据。</p><table><thead><tr><th style="text-align:center;"></th><th style="text-align:center;">Vite</th><th style="text-align:center;">Webpack</th><th style="text-align:center;">提升倍数</th></tr></thead><tbody><tr><td style="text-align:center;">启动项目</td><td style="text-align:center;">0.5s</td><td style="text-align:center;">33s</td><td style="text-align:center;"><strong>66 倍</strong></td></tr><tr><td style="text-align:center;">首屏</td><td style="text-align:center;">19s</td><td style="text-align:center;">36s</td><td style="text-align:center;">1.9 倍</td></tr><tr><td style="text-align:center;">HMR</td><td style="text-align:center;">0.2s</td><td style="text-align:center;">6s</td><td style="text-align:center;"><strong>30 倍</strong></td></tr></tbody></table><p>这个是目前升级前后的对比数据，大概的。所以这是解决开发痛点的原因！ 而且随着项目的越来越大，模块越来越多，组件越来越多，就会从 6s =&gt; 7s =&gt; 8s =&gt; ...人生 over</p><p>我相信最开始这个系统的 HMR 也会在 <strong>1s</strong> 以内的。</p><h4 id="实践并应用于项目" tabindex="-1"><a class="header-anchor" href="#实践并应用于项目"><span>实践并应用于项目</span></a></h4><p>其实这个不光是说说，我在 Q2 就跟组内成员提过说要提升一下开发效率，用 Vite 作为开发构建工具，来实际提升。当然现在也应用于项目上了。文章后面会有本次升级的经验以及一些报错和解决的方式，大家可以用作参考。这也是本次分享的目的！</p><h2 id="大纲" tabindex="-1"><a class="header-anchor" href="#大纲"><span>大纲</span></a></h2><ul><li>什么是 Vite ?</li><li>Vite 原理浅析</li><li>Vite 应用及实践</li><li>个人对 Vite 的一些想法</li></ul><h2 id="什么是-vite" tabindex="-1"><a class="header-anchor" href="#什么是-vite"><span>什么是 Vite ?</span></a></h2><h3 id="下一代前端开发与构建工具" tabindex="-1"><a class="header-anchor" href="#下一代前端开发与构建工具"><span>下一代前端开发与构建工具</span></a></h3><ul><li>极速的服务启动</li><li>轻量快速的热重载</li><li>丰富的功能</li><li>通用的插件</li></ul><h4 id="极速的服务启动" tabindex="-1"><a class="header-anchor" href="#极速的服务启动"><span>极速的服务启动</span></a></h4><p>为什么是极速的服务启动，其实你可以理解为只是启动了一个本地服务器，你可以想象一下自己启动一个 <code>node</code> 服务器是有多么的快？<code>node index.js</code> 之后回车是不是就已经开启了一个服务器？ 其实 <code>Vite</code> 也是这样的，它只是启动了一个 <code>node</code> 服务器而已，只不过在第一次启动之前会有一个预编译的过程，可能会出现几秒的启动速度（取决于你的项目需要预编译的包多少）。</p><p>所以 <code>Vite</code> 在启动服务器的时候是非常极速的。</p><h4 id="轻量快速的热重载" tabindex="-1"><a class="header-anchor" href="#轻量快速的热重载"><span>轻量快速的热重载</span></a></h4><p><code>Vite</code> 实现了一套基于 <code>ESM</code> 模块的 <code>HMR</code> ，通过 <code>websocket</code> 来实现。</p><p>它会将你的所有文件添加一个 <code>watcher</code> ，来监听你的文件变动，实现热重载。</p><p>快速的热重载如何体现？类似 <code>Webpack</code> 进行热更新时，会将你的所有文件重新打包一次，来实现热更新，而 <code>vite</code> 是只重载你更改的那个文件，通过 <code>HTTP</code> 来重新发送请求即可实现，所以是快速的。不需要将你的其他代码进行打包。</p><h4 id="丰富的功能" tabindex="-1"><a class="header-anchor" href="#丰富的功能"><span>丰富的功能</span></a></h4><p>丰富的功能体现于 <code>Vite</code> 自己的配置文件 API ，你可以做很多事情，例如文件别名、接口代理、插件机制、端口、服务器协议、打包配置等等等，都可以根据你生成的配置进行改写。</p><h4 id="通用的插件" tabindex="-1"><a class="header-anchor" href="#通用的插件"><span>通用的插件</span></a></h4><p><code>Vite</code> 在实现之前就已经考虑到，一定不会如 <code>Webpack</code> 的插件以及社区成熟，那样将好几年都不会被应用到生产中，尤大很聪明，通过目前仅次于 <code>Webpack</code> 的打包器 <code>Rollup</code> 的插件来实现自己的插件机制。</p><p>也就是说，你可以使用 <code>Rollup</code> 插件来进行配置 <code>Vite</code>，当然你写的 <code>Vite</code> 插件，按照规范也可以在 <code>Rollup</code> 上使用。实现了通用的插件逻辑，这样在生态上，也不会输于 <code>Webpack</code>。</p><h3 id="通过官方的对比图看一下-vite-和-webpack-的区别" tabindex="-1"><a class="header-anchor" href="#通过官方的对比图看一下-vite-和-webpack-的区别"><span>通过官方的对比图看一下 Vite 和 Webpack 的区别</span></a></h3><p>类似 <code>Webpack</code> 工具的打包方式</p><p><img src="https://cdn.jsdelivr.net/gh/0xe69e97/image-PicX@master/Blog/image.1ccyhpb2f9wg.png" alt="类似  工具的打包方式"></p><p><code>Vite</code> 的打包方式</p><p><img src="https://cdn.jsdelivr.net/gh/0xe69e97/image-PicX@master/Blog/image.17rxkflkt5kw.png" alt=" 的打包方式"></p><p>好的，通过上面的对比我们可以看到。</p><p><code>Webpack</code> 的方式是将你的所有的代码统一进行编译，包括所有的 <code>router</code> 以及下面的模块，模块下还有各个组件。打包成浏览器可以识别的代码，都打包完成之后，启动服务器，统一给浏览器使用。</p><p>而 <code>Vite</code> 的方式是直接先启动服务器，其实图上少了一个步骤，在启动服务器之前会先读取你的 <code>package.json</code> 文件，识别出需要进行预编译的包，先进行预编译之后，再去启动服务器。</p><p>启动服务器之后会通过发送 <code>HTTP</code> 请求的模式访问入口文件，入口文件访问当前页面路由所需要的模块，以及模块下的组件，当你通过路由导航到另一个路由下，如果这个路由下的模块与上个模块有重合部分，这时 <code>Vite</code> 将会采用缓存的内容，不会发送请求，如果没有则继续发送对应的文件请求。高效的利用了 <code>tree shaking</code> 特性。这也是为什么不管你的项目多大， HMR 都会保持在非常高速的进行的原因。</p><p>好了，见到介绍到这之后，我们来看一下 <code>Vite</code> 原理的浅析。</p><h2 id="vite-原理浅析" tabindex="-1"><a class="header-anchor" href="#vite-原理浅析"><span>Vite 原理浅析</span></a></h2><p>本次的原理分析主要是带大家看一下 Vite 在实际工作当中的用途，会写一个简单的 Demo 来实现，只是实现思路，可以保证运行你刚 Create Vite App 的 React 的 Demo</p><p>在学习 Vite 原理之前首先得先看一下两个知识点，也是支撑 Vite 这么强大的原因。</p><h3 id="esm-ecmascript-modules" tabindex="-1"><a class="header-anchor" href="#esm-ecmascript-modules"><span>ESM (ECMAScript Modules)</span></a></h3><p>如果你还不了解 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Guide/Modules" target="_blank" rel="noopener noreferrer">ESM</a>，可以简单看一下。</p><p>简单来说 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Guide/Modules" target="_blank" rel="noopener noreferrer">ESM</a> 就是原生浏览器支持 <code>import</code> 和 <code>export</code> 等 ES6 特性。</p><p>看一下我们的 Demo HTML 代码</p><p><img src="https://cdn.jsdelivr.net/gh/0xe69e97/image-PicX@master/Blog/image.3mxzaeej4e00.png" alt="Demo HTML Code"></p><p>不知道大家之前在开发的时候用到过 <code>type=&quot;module&quot;</code> 这个类型没，我是没用到过，接触 Vite 之后才知道这个东西。</p><p>我们可以直接指定 <code>type</code> 的类型就可以在现代浏览器上使用 ESM 模块了。我们来看一下它的兼容性</p><p><img src="https://cdn.jsdelivr.net/gh/0xe69e97/image-PicX@master/Blog/image.312ygvbiml80.png" alt="import 兼容性"></p><p><img src="https://cdn.jsdelivr.net/gh/0xe69e97/image-PicX@master/Blog/image.4np1h888m2w0.png" alt="export 兼容性"></p><p>大家可以看到哈，目前现代浏览器都已经支持了，除了 IE。都 2120 年了，谁还在兼容 IE 浏览器？让我康一康</p><p>好的，ESM 已经了解了，我们聊下一个比较厉害的工具。</p><h3 id="esbuild" tabindex="-1"><a class="header-anchor" href="#esbuild"><span>esbuild</span></a></h3><p><a href="https://esbuild.github.io/" target="_blank" rel="noopener noreferrer">esbuild</a>，是一个极速的 JavaScript 的代码打包器，用 Go 语言进行编写，是其他编译器的 <strong>10-100 倍</strong>运行速度</p><p>Vite 就是采用了 esbuild 作为代码打包的工具，所以他的快也体现在 esbuild</p><h2 id="手写-vite-感受原理" tabindex="-1"><a class="header-anchor" href="#手写-vite-感受原理"><span>手写 Vite 感受原理</span></a></h2><p>这里带大家简单写个 Vite 的 Demo，了解一下 Vite 的工作原理，大致的思路，并不会很完善的实现，因为这不现实，如果大家非常感兴趣的话，可以去看一下 <a href="https://github.com/vitejs/vite" target="_blank" rel="noopener noreferrer"> Vite 的源码</a>，非常值得学习。</p><p>我们主要实现你在创建一个基于 React 的 Vite template Demo 实现，主要实现如下：</p><ul><li>启动 Node 服务器</li><li>处理 HTML 文件</li><li>处理 JSX 文件</li><li>处理 CSS 文件</li><li>处理 SVG 图片文件</li><li>处理裸模块</li><li>使用 esbuild 打包 React 源码</li></ul><p><img src="https://cdn.jsdelivr.net/gh/0xe69e97/image-PicX@master/Blog/image.7cywvqp28xc0.png" alt=""></p><ol><li>首先在项目根目录创建一个前端模版，代码如下：</li></ol><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token constant">DOCTYPE</span> html<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span>html lang<span class="token operator">=</span><span class="token string">&quot;en&quot;</span><span class="token operator">&gt;</span></span>
<span class="line">  <span class="token operator">&lt;</span>head<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token string">&quot;UTF-8&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>link rel<span class="token operator">=</span><span class="token string">&quot;icon&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;image/svg+xml&quot;</span> href<span class="token operator">=</span><span class="token string">&quot;/src/favicon.svg&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>meta name<span class="token operator">=</span><span class="token string">&quot;viewport&quot;</span> content<span class="token operator">=</span><span class="token string">&quot;width=device-width, initial-scale=1.0&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>Vite App<span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">&gt;</span></span>
<span class="line">  <span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">&gt;</span></span>
<span class="line">  <span class="token operator">&lt;</span>body<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>script<span class="token operator">&gt;</span></span>
<span class="line">      window<span class="token punctuation">.</span>process <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">env</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token constant">NODE_ENV</span><span class="token operator">:</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">&quot;root&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">&quot;module&quot;</span> src<span class="token operator">=</span><span class="token string">&quot;./vitesrc/main.jsx&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span></span>
<span class="line">  <span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">&gt;</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以重点看一下 <code>&lt;script type=&#39;module&#39; ...&gt;&lt;/script&gt;</code></p><p>这个类型就是 ESM 的模块的类型。</p><ol start="2"><li>创建 vitesrc 文件夹作为我们业务代码的核心代码文件夹</li></ol><p>代码省略了，由于是展示 Node 层面代码，所以不展示了，其实就是在你创建 Vite React 模版的代码</p><p>代码目录结构如下：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line">vitesrc</span>
<span class="line">├── App.css</span>
<span class="line">├── App.jsx</span>
<span class="line">├── favicon.svg</span>
<span class="line">├── index.css</span>
<span class="line">├── logo.svg</span>
<span class="line">└── main.jsx</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>在根目录下创建我们的核心文件，也是 Vite 的源码文件，index.js</li></ol><p>直接通过 Koa 来作为我们的服务器框架。代码如下：</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> Koa <span class="token keyword">from</span> <span class="token string">&quot;koa&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">&quot;text/plan&quot;</span><span class="token punctuation">;</span></span>
<span class="line">  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">&quot;Hello Vite!&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">24678</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;App is running&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>推荐使用 PM2 作为 Node 的进程守护</strong></p><p>启动这个文件之后，我们在浏览器输入 <code>localhost:24678</code> 即可看到一个 Node 服务已经启动了。</p><p><img src="https://cdn.jsdelivr.net/gh/0xe69e97/image-PicX@master/Blog/image.423yo8s9ydy0.png" alt="服务器启动"></p><p><em>注意：之后的代码都是新增的代码，就不进行全量展示了，不然太长～</em></p><ol start="4"><li>处理 HTML 文件</li></ol><p>这里我们处理一下 HTML 文件，当前端请求的时候，直接通过 Node 读取前端所写的模版，直接进行返回即可。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> fs <span class="token keyword">from</span> <span class="token string">&quot;fs&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> __dirname <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> requestUrl <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>url<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>requestUrl <span class="token operator">===</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 根路径返回模版 HTML 文件</span></span>
<span class="line">    <span class="token keyword">const</span> html <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>__dirname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/index.html</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">&quot;text/html&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> html<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>此时我们刷新页面查看一定会报错，因为我们的 <code>index.html</code> 模版引用了 <code>main.jsx</code> 文件，但是我们的 Node 服务器并没有做任何的处理，所以一定会报错 <code>404</code></p><p><img src="https://cdn.jsdelivr.net/gh/0xe69e97/image-PicX@master/Blog/image.5lngzawyb140.png" alt="main.jsx 404"></p><ol start="5"><li>处理 JSX 文件</li></ol><p>我们加入处理 JSX 的代码</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// ...</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>requestUrl <span class="token operator">===</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// ...</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>requestUrl<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&quot;.jsx&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// jsx 文件返回 JavaScript 文件类型以及获取文件路径返回前端</span></span>
<span class="line">    <span class="token keyword">const</span> filePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>requestUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> JSXFile <span class="token operator">=</span> <span class="token function">rewriteImport</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">&quot;application/javascript&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> JSXFile<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>好了，此时我们的 JSX 文件就已经可以正常返回给前端了，但是大家会发现屏幕还是白的。</p><p><img src="https://cdn.jsdelivr.net/gh/0xe69e97/image-PicX@master/Blog/image.w7p1y0uulm.png" alt="引入 JSX 文件"></p><p>为什么这样呢？因为我们只是将 JSX 文件的源码给前端了，浏览器并不认识 JSX 文件里面的一些 JSX 语法的代码，所以这里我们需要通过 <code>esbuild</code> 来将 JSX 的代码进行转译（在 Vite 当中也是这样，只不过 Vite 会先将 React 依赖包进行预编译，但是这里需要我们一会进行处理），处理代码如下：</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> transformSync <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;esbuild&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// ...</span></span>
<span class="line"><span class="token comment">// 通过 esbuild 的 transformSync API 进行代码转译</span></span>
<span class="line"><span class="token keyword">const</span> out <span class="token operator">=</span> <span class="token function">transformSync</span><span class="token punctuation">(</span>JSXFile<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">jsxFragment</span><span class="token operator">:</span> <span class="token string">&quot;Fragment&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">&quot;jsx&quot;</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">&quot;application/javascript&quot;</span><span class="token punctuation">;</span></span>
<span class="line">ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> out<span class="token punctuation">.</span>code<span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// ...</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>好的，我们现在可以在刷新浏览器，看一下 JSX 的代码是不是被转译成了浏览器可以认识的代码。</p><p><img src="https://cdn.jsdelivr.net/gh/0xe69e97/image-PicX@master/Blog/image.5gh2usywuuw0.png" alt="esbuild 转换 JSX 语法"></p><p>我们所有自己写的 JSX 语法已经被 <code>esbuild</code> 转换成了普通 JS 方法</p><p>此时我们去看一下浏览器的 Console 的 Tab ，会有一个 ESM 模块的报错</p><p><img src="https://cdn.jsdelivr.net/gh/0xe69e97/image-PicX@master/Blog/image.5m1jvfuhbkw0.png" alt="Console 报错"></p><p>它说我们的 react 模块它不认识，必须要使用 <code>&quot;/&quot; &quot;./&quot; &quot;../&quot;</code> 这些相对路径才可以，这也是 ESM 不支持<strong>裸模块</strong>的原因，所以我们需要统一处理裸模块</p><ol start="6"><li>处理裸模块</li></ol><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span>requestUrl<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&quot;.jsx&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// jsx 文件返回 JavaScript 文件类型以及获取文件路径返回前端</span></span>
<span class="line">  <span class="token keyword">const</span> filePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>requestUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 重写路径</span></span>
<span class="line">  <span class="token keyword">const</span> JSXFile <span class="token operator">=</span> <span class="token function">rewriteImport</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">const</span> out <span class="token operator">=</span> <span class="token function">transformSync</span><span class="token punctuation">(</span>JSXFile<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">jsxFragment</span><span class="token operator">:</span> <span class="token string">&quot;Fragment&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">&quot;jsx&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">&quot;application/javascript&quot;</span><span class="token punctuation">;</span></span>
<span class="line">  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> out<span class="token punctuation">.</span>code<span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">rewriteImport</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> content<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex"> from [&#39;&quot;](.*)[&#39;&quot;]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">s0<span class="token punctuation">,</span> s1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>s1<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;./&quot;</span><span class="token punctuation">)</span> <span class="token operator">||</span> s1<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span> <span class="token operator">||</span> s1<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;../&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> s0<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// 裸模块</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> from &#39;/@modules/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>s1<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&#39;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>现在所有的裸模块都已经被我们把路径给重写成 <code>/@modules/</code> 了，所以浏览器不会报 ESM 的错了，而是报 404 的问题。接下来我们来处理 <code>/@modules/</code> 模块</p><p><img src="https://cdn.jsdelivr.net/gh/0xe69e97/image-PicX@master/Blog/image.4cc4blp49hi0.png" alt="/@modules/ 模块"></p><ol start="7"><li>处理自定义的裸模块 &#39;/@modules/&#39;</li></ol><p>此时我们来匹配 <code>/@modules/</code> 模块，因为重写 URL 之后，浏览器会重新发送 <code>/@modules/</code> 下的请求，从上图的 404 就可以看出来，这时我们在对这个模块进行处理。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> buildSync <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;esbuild&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ...</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span>requestUrl<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;/@modules/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// 将自定义的模块名称替换掉，拿到原始“裸模块”名称</span></span>
<span class="line">  <span class="token keyword">const</span> modulesName <span class="token operator">=</span> requestUrl<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;/@modules/&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 获取裸模块的 package.json 文件下的 main 字段，这个字段是代码打包后的入口文件</span></span>
<span class="line">  <span class="token keyword">const</span> entryFile <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span></span>
<span class="line">    fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span></span>
<span class="line">      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>__dirname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/node_modules/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>modulesName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/package.json</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string">&quot;utf8&quot;</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">)</span><span class="token punctuation">.</span>main<span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 直接拼接出包的路径</span></span>
<span class="line">  <span class="token keyword">const</span> pkgPath <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>__dirname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/node_modules/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>modulesName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>entryFile<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// 尝试去获取 /node_modules/.vite 下的编译过后的文件</span></span>
<span class="line">  <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">    body <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>__dirname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/node_modules/.vite/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>modulesName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 如果获取不到，使用 ESBuild 打包裸模块里的内容，转换为 ESM 供浏览器使用</span></span>
<span class="line">    <span class="token comment">// 并且存入 /node_modules/.vite 缓存目录中</span></span>
<span class="line">    <span class="token comment">// 这步操作其实就是 vite 在预编译执行的</span></span>
<span class="line">    <span class="token function">buildSync</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">entryPoints</span><span class="token operator">:</span> <span class="token punctuation">[</span>pkgPath<span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">bundle</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">outfile</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>__dirname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/node_modules/.vite/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>modulesName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token string">&quot;esm&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 最后返回当前编译后的 JS 文件</span></span>
<span class="line">    body <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>__dirname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/node_modules/.vite/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>modulesName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">&quot;application/javascript&quot;</span><span class="token punctuation">;</span></span>
<span class="line">  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> body<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token comment">// ...</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>此时可以看到我们的裸模块内容已经可以被浏览器正确的识别了。</p><p><img src="https://cdn.jsdelivr.net/gh/0xe69e97/image-PicX@master/Blog/image.1cx8p8bujkjk.png" alt="裸模块解析完成"></p><p>可以看到还有 css 文件需要处理，接下里处理 css 样式文件</p><ol start="8"><li>简单处理 CSS 样式文件</li></ol><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// ...</span></span>
<span class="line"><span class="token comment">// 通过 esbuild 的 transformSync API 进行代码转译</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span>requestUrl<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&quot;.css&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> filePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>requestUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">const</span> CSSFile <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">const</span> file <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"></span>
<span class="line">      const style = document.createElement(&#39;style&#39;)</span>
<span class="line">      style.textContent = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>CSSFile<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"></span>
<span class="line">      document.head.appendChild(style)</span>
<span class="line">      export default {}</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></span>
<span class="line">  ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">&quot;text/javascript&quot;</span><span class="token punctuation">;</span></span>
<span class="line">  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> file<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token comment">// ...</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>由于 ESM 只能接受 <code>Content-Type</code> 为 <code>text/javascript</code> 类型，所以只能通过 JS 的方式去插入到 <code>index.html</code> 中</p><p><img src="https://cdn.jsdelivr.net/gh/0xe69e97/image-PicX@master/Blog/image.16eb1bndmfmo.png" alt="处理 CSS 样式文件效果"></p><ol start="9"><li>简单处理 svg 图片</li></ol><p>由于 css 和图片并不是要展示的内容，所以就越简单越好，目前的思路是直接将图片转为 <code>base64</code> 格式，在 Vite 当中，只有图片足够小才会使用 base64 的格式，代码如下：</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// ...</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span>requestUrl<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&quot;.svg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> filePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>requestUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">const</span> imageFile <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">&quot;text/javascript&quot;</span><span class="token punctuation">;</span></span>
<span class="line">  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">export default &#39;data:image/svg+xml;base64,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span></span>
<span class="line">    imageFile<span class="token punctuation">,</span></span>
<span class="line">    <span class="token string">&quot;binary&quot;</span></span>
<span class="line">  <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">&quot;base64&quot;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&#39;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token comment">// ...</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后我们在做一下容错处理，将其他不认识的文件类型都简单容错一下</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">	<span class="token comment">// ...</span></span>
<span class="line">	 <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">    ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">&#39;text/javascript&#39;</span></span>
<span class="line">    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>requestUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">	<span class="token comment">// ...</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://cdn.jsdelivr.net/gh/0xe69e97/image-PicX@master/Blog/image.6sws0rwjv4w0.png" alt="大功告成"></p><p>好了！！此时我们的 Vite-Demo 已经彻底跑起来了。</p><ol start="10"><li>处理 <strong>HMR</strong></li></ol><p>重点来了，如何简易的实现 HMR 功能</p><p>整体的原理为 Websocket 实现热模块替换功能。Vite 是这么做的，通过给每一个文件注入 import.meta.hot 等方式，在保存时，通过服务端通知客户端进行文件的重新请求来实现 HMR，接下来我们简单实现一版</p><p>首先改造一下在处理 HTML 文件的时候，加入 Websocket 客户端代码</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// ...</span></span>
<span class="line"><span class="token comment">// 根路径返回模版 HTML 文件</span></span>
<span class="line"><span class="token keyword">const</span> html <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>__dirname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/index.html</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> footer <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"></span>
<span class="line">    &lt;script&gt;</span>
<span class="line">      const ws = new WebSocket(&#39;ws://localhost:1123&#39;)</span>
<span class="line"></span>
<span class="line">      ws.addEventListener(&#39;message&#39;, async function incoming(value) {</span>
<span class="line">        function hotUpdate() {</span>
<span class="line">          const script = document.querySelectorAll(&#39;script&#39;)</span>
<span class="line">          document.body.removeChild(script[script.length - 1])</span>
<span class="line">          const newScript = document.createElement(&#39;script&#39;)</span>
<span class="line">          newScript.type = &#39;module&#39;</span>
<span class="line">          newScript.src = &#39;./vitesrc/main.jsx?import=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&#39;</span>
<span class="line">          document.body.appendChild(newScript)</span>
<span class="line">        }</span>
<span class="line">        hotUpdate()</span>
<span class="line">      });</span>
<span class="line">    &lt;/script&gt;</span>
<span class="line">    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></span>
<span class="line">ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">&quot;text/html&quot;</span><span class="token punctuation">;</span></span>
<span class="line">ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>html<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>footer<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// ...</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过读取文件，重写文件返回前端，默认添加上 Websocket 相应代码逻辑即可。我们再来添加一下服务端的 Websocket ，通过 <code>ws</code> 模块引入</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> WebSocketServer <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;ws&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> Websocket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocketServer</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token number">1123</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// HMR</span></span>
<span class="line">Websocket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;connection&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token function">connection</span><span class="token punctuation">(</span><span class="token parameter">ws</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  ws<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token function">incoming</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;received: %s&quot;</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 监听当前路径下的所有文件</span></span>
<span class="line">  chokidar<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">&quot;./vitesrc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;change&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">changePath</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// const filePath = path.resolve(__dirname, changePath);</span></span>
<span class="line">    <span class="token comment">// const data = fs.readFileSync(filePath, &#39;utf-8&#39;);</span></span>
<span class="line">    ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>changePath<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>监听之后在更改 &#39;./vitesrc&#39; 文件下的内容后，就会看到客户端收到服务端发送的数据了。</p><p>之后客户端会根据我们之前注入到 <code>index.html</code> 文件内的代码进行重新引入入口文件，实现浏览器的重新请求文件。</p><p>然后通过处理 <code>.jsx</code> 文件来热更新</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">let</span> realCode <span class="token operator">=</span> out<span class="token punctuation">.</span>code<span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// 自定义 import 为需要热更新</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;?&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">?.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&quot;import&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  realCode <span class="token operator">=</span> out<span class="token punctuation">.</span>code<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span></span>
<span class="line">    <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex"> from [&#39;&quot;](.*\.jsx.*)[&#39;&quot;]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">function</span> <span class="token function">rewriteCode</span><span class="token punctuation">(</span><span class="token parameter">s0<span class="token punctuation">,</span> s1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> from &#39;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>s1<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&#39;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">&quot;application/javascript&quot;</span><span class="token punctuation">;</span></span>
<span class="line">ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> realCode<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>自定义的 import 参数如果有，认为是需要热更新的文件，将 jsx 文件引入路径添加时间戳，让浏览器的缓存失效，请求过后，文件即更新。</p><p>好了，此时我们修改 &#39;./vitesrc&#39; 下面的任意一个文件，都会看到浏览器会发送对应的请求信息</p><p><img src="https://cdn.jsdelivr.net/gh/0xe69e97/image-PicX@master/Blog/image.cihlkxatp34.png" alt="image"></p><p>手写 Vite 的实现思路就到这里。感谢大家的认真观看，接下来将在我们的项目上接入 Vite 并且在踩坑的过程中遇到的问题进行一一解决。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> Koa <span class="token keyword">from</span> <span class="token string">&quot;koa&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> fs <span class="token keyword">from</span> <span class="token string">&quot;fs&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> path <span class="token keyword">from</span> <span class="token string">&quot;path&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> buildSync<span class="token punctuation">,</span> transformSync <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;esbuild&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> __dirname <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> requestUrl <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>url<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>requestUrl <span class="token operator">===</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 根路径返回模版 HTML 文件</span></span>
<span class="line">    <span class="token keyword">const</span> html <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>__dirname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/index.html</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">&quot;text/html&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> html<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>requestUrl<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&quot;.jsx&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// jsx 文件返回 JavaScript 文件类型以及获取文件路径返回前端</span></span>
<span class="line">    <span class="token keyword">const</span> filePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>requestUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> JSXFile <span class="token operator">=</span> <span class="token function">rewriteImport</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">const</span> out <span class="token operator">=</span> <span class="token function">transformSync</span><span class="token punctuation">(</span>JSXFile<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">jsxFragment</span><span class="token operator">:</span> <span class="token string">&quot;Fragment&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">&quot;jsx&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">&quot;application/javascript&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> out<span class="token punctuation">.</span>code<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>requestUrl<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;/@modules/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> modulesName <span class="token operator">=</span> requestUrl<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;/@modules/&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> entryFile <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span></span>
<span class="line">      fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span></span>
<span class="line">        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>__dirname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/node_modules/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>modulesName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/package.json</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;utf8&quot;</span></span>
<span class="line">      <span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">)</span><span class="token punctuation">.</span>main<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> pkgPath <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>__dirname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/node_modules/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>modulesName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>entryFile<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 尝试去获取 /node_modules/.vite 下的编译过后的文件</span></span>
<span class="line">    <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">      body <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span></span>
<span class="line">        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>__dirname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/node_modules/.vite/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>modulesName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.js</span><span class="token template-punctuation string">`</span></span></span>
<span class="line">      <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// 如果获取不到，使用 ESBuild 打包裸模块里的内容，转换为 ESM 供浏览器使用</span></span>
<span class="line">      <span class="token comment">// 并且存入 /node_modules/.vite 缓存目录中</span></span>
<span class="line">      <span class="token comment">// 这步操作其实就是 vite 在预编译执行的</span></span>
<span class="line">      <span class="token function">buildSync</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">entryPoints</span><span class="token operator">:</span> <span class="token punctuation">[</span>pkgPath<span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">bundle</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">outfile</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>__dirname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/node_modules/.vite/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>modulesName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token string">&quot;esm&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token comment">// 最后返回当前编译后的 JS 文件</span></span>
<span class="line">      body <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span></span>
<span class="line">        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>__dirname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/node_modules/.vite/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>modulesName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.js</span><span class="token template-punctuation string">`</span></span></span>
<span class="line">      <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">&quot;application/javascript&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> body<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>requestUrl<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&quot;.css&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> filePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>requestUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> CSSFile <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">const</span> file <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"></span>
<span class="line">    const style = document.createElement(&#39;style&#39;)</span>
<span class="line">    style.textContent = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>CSSFile<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"></span>
<span class="line">    document.head.appendChild(style)</span>
<span class="line">    export default {}</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></span>
<span class="line">    ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">&quot;text/javascript&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> file<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>requestUrl<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&quot;.svg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> filePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>requestUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> imageFile <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">&quot;text/javascript&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">export default &#39;data:image/svg+xml;base64,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span></span>
<span class="line">      imageFile<span class="token punctuation">,</span></span>
<span class="line">      <span class="token string">&quot;binary&quot;</span></span>
<span class="line">    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">&quot;base64&quot;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&#39;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">    ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">&quot;text/javascript&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>requestUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">rewriteImport</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> content<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex"> from [&#39;&quot;](.*)[&#39;&quot;]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">s0<span class="token punctuation">,</span> s1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>s1<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;./&quot;</span><span class="token punctuation">)</span> <span class="token operator">||</span> s1<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span> <span class="token operator">||</span> s1<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;../&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> s0<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// 裸模块</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> from &#39;/@modules/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>s1<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&#39;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">24678</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;App is running&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="vite-应用及实践" tabindex="-1"><a class="header-anchor" href="#vite-应用及实践"><span>Vite 应用及实践</span></a></h2><p>在上面了解到了 Vite 的简单思路和原理，接下来就是应用以及实践的部分了。</p><p>这个部分的实践是通过我目前在做的广告投放后台管理系统之上做的。也就是最开头说的，要解决业务的痛点。</p><h3 id="webpack-升级-vite" tabindex="-1"><a class="header-anchor" href="#webpack-升级-vite"><span>Webpack 升级 Vite</span></a></h3><p>在使用 Webpack 时升级 Vite 有几个步骤</p><ol><li>安装 Vite</li></ol><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token function">yarn</span> <span class="token function">add</span> vite</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ol start="2"><li>配置 vite.config.js</li></ol><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> defineConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;vite&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// https://vitejs.dev/config/</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// ...</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>启动 Vite</li></ol><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># 当然需要你先去配置 scripts 命令</span></span>
<span class="line"><span class="token function">yarn</span> vite</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>好了，如果你已经按照上面三个步骤做完了之后，你的项目就是 Vite 的构建了。是不是很简单？</p><p>开个玩笑～如果一切正常的话，你会收获一堆报错以及各式各样你没遇到过的问题。。</p><p>最后介绍一个工具 <a href="https://github.com/tnfe/wp2vite" target="_blank" rel="noopener noreferrer">wp2vite</a> ，一个让 webpack 项目支持 vite 的前端项目的转换工具。</p><p>我在使用的时候也不清楚是项目太老的问题还是配置问题，还是这个工具的 Bug ，总说找不到我的 Webpack 配置文件，就算指定了配置文件入口也不行。所以干脆我就没用，直接自己手动升级。</p><h3 id="广告投放平台升级-vite" tabindex="-1"><a class="header-anchor" href="#广告投放平台升级-vite"><span>广告投放平台升级 Vite</span></a></h3><p>接下来我将把我在历时 2 个多月的时间升级到 Vite 的遇到的问题以及经验分享出来，我会抛出 9 个问题，并且每个问题之后都会给出解决方案，如果小伙伴们有更好的方法或者建议，欢迎评论哦～</p><p>这里每个问题都是在升级的时候的绊脚石，一个个的去解决之后，我们的广告投放平台才跑起来，一直到现在直接切入业务开发，为业务开发提效！</p><h3 id="q1-vite-不支持-js-写-jsx-文件" tabindex="-1"><a class="header-anchor" href="#q1-vite-不支持-js-写-jsx-文件"><span>Q1：Vite 不支持 .js 写 JSX 文件</span></a></h3><p>由于我们项目较老，而且开发的时候应该是很着急，所以所有的文件都是已 .js 结尾，然后写的 React 代码，所以我碰到了这个问题，看一下报错信息。</p><p><img src="https://cdn.jsdelivr.net/gh/0xe69e97/image-PicX@master/Blog/image.2c1pshw1j4ys.png" alt="JSX 报错问题"></p><p>这个是 Vite 默认就不支持的问题，所以这里会有切合业务的两个问题：</p><ol><li>需要将所有的文件类型改写成 JSX or TSX</li><li>项目模块过多，组件更多，一个个改不现实</li></ol><p><strong>解决方案</strong></p><p>在 Vite 仓库下看到的一个 <a href="https://github.com/vitejs/vite/issues/1552" target="_blank" rel="noopener noreferrer">Issues</a> ，感兴趣的同学可以看一下，还是比较有意思的，贴个截图出来。</p><p><img src="https://cdn.jsdelivr.net/gh/0xe69e97/image-PicX@master/Blog/image.510nqdea3cs0.png" alt="issues 截图"></p><p>通过批量修改文件下所有的 js 文件后缀为 jsx</p><p>通过 Node 读取所有的文件内容，如果包含了 <code>React</code> 则一定是 JSX 文件，那么就重新命名为 [name].jsx 即可，代码如下：</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> dirPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;./src&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token function-variable function">readFile</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">filePath</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> files <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  files<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">filename</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> fileDir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>fileDir<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> stats</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;获取文件stats失败&quot;</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> isFile <span class="token operator">=</span> stats<span class="token punctuation">.</span><span class="token function">isFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//是文件</span></span>
<span class="line">        <span class="token keyword">const</span> isDir <span class="token operator">=</span> stats<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//是文件夹</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>isFile<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token keyword">const</span> content <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>fileDir<span class="token punctuation">,</span> <span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">          <span class="token keyword">const</span> fileObj <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>fileDir<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">          <span class="token keyword">if</span> <span class="token punctuation">(</span>fileObj<span class="token punctuation">.</span>ext <span class="token operator">===</span> <span class="token string">&quot;.ts&quot;</span> <span class="token operator">||</span> fileObj<span class="token punctuation">.</span>ext <span class="token operator">===</span> <span class="token string">&quot;.js&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>content<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&quot;React&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">              <span class="token keyword">const</span> newFileName <span class="token operator">=</span> fileObj<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">&quot;.jsx&quot;</span><span class="token punctuation">;</span></span>
<span class="line">              <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">                fs<span class="token punctuation">.</span><span class="token function">renameSync</span><span class="token punctuation">(</span>fileDir<span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>fileObj<span class="token punctuation">.</span>dir<span class="token punctuation">,</span> newFileName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">              <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">              <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">              <span class="token comment">// 不处理</span></span>
<span class="line">              console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">不处理的文件 ===&gt;&gt;&gt; </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fileDir<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">              <span class="token comment">// console.log(content)</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">          <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>isDir<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token function">readFile</span><span class="token punctuation">(</span>fileDir<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//递归，如果是文件夹，就继续遍历该文件夹下面的文件</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token function">readFile</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>也有可能误伤哈，这个就需要大家自己看一下了，我这里是有几个小问题，但是影响不大，也就一会就解决了。</p><h3 id="q2-添加别名" tabindex="-1"><a class="header-anchor" href="#q2-添加别名"><span>Q2：添加别名</span></a></h3><p>由于我们之前项目中配置的 Webpack 别名 <code>@ === ./src</code> 所以在 Vite. 中也需要配置一下。十分简单，配置文件代码如下：</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> defineConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vite&#39;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token comment">// ...</span></span>
<span class="line">  <span class="token literal-property property">resolve</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">alias</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">      <span class="token punctuation">{</span> <span class="token literal-property property">find</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^@</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token literal-property property">replacement</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&#39;./src&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">]</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token comment">// ...</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>但是配置 <code>@</code> 之后，发现 Vite 报错了。。</p><p><img src="https://cdn.jsdelivr.net/gh/0xe69e97/image-PicX@master/Blog/image.67f5a472ch40.png" alt="配置别名报错"></p><p>应该是将这种包名的也给全局替换了，所以出现这个问题，试了几个办法，并没有有效的解决这个问题。。如果大佬有解决的思路欢迎告知呀！！不胜感激！</p><p><strong>解决方案</strong></p><p>之后就通过更改别名为 <code>@src</code> 来解决这个问题了。。</p><p><strong>注意：如果你没有完全抛弃 Webpack 记得在 Webpack 上的别名配置做同步修改，否则在开发时没问题，打包上线出现问题</strong></p><h3 id="q3-不支持依赖包内通过相对路径引用" tabindex="-1"><a class="header-anchor" href="#q3-不支持依赖包内通过相对路径引用"><span>Q3：不支持依赖包内通过相对路径引用</span></a></h3><p><img src="https://cdn.jsdelivr.net/gh/0xe69e97/image-PicX@master/Blog/image.1ugapjvderi8.png" alt="报错信息"></p><p>这个问题找了好久，在 Github 上这个仓库的源码的写法也是裸模块的引用，但是在 <code>yarn install</code> 安装依赖的时候，就是相对路径。。</p><p><strong>解决方案</strong></p><p>通过别名配置 Hack 这个依赖包</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token comment">// ...</span></span>
<span class="line">  <span class="token literal-property property">resolve</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">alias</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">      <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">find</span><span class="token operator">:</span> <span class="token string">&#39;venn.js&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">replacement</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&#39;./node_modules/venn.js/build/venn.js&#39;</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">]</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token comment">// ...</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><a href="https://www.gitmemory.com/nicholasxjy" target="_blank" rel="noopener noreferrer">参考文献</a></p><h3 id="q4-esm-不支持-符号" tabindex="-1"><a class="header-anchor" href="#q4-esm-不支持-符号"><span>Q4：ESM 不支持 ～ 符号</span></a></h3><p><img src="https://cdn.jsdelivr.net/gh/0xe69e97/image-PicX@master/Blog/image.1yacduyfw0gw.png" alt="image"></p><p>这个是因为我们在使用 less 的时候，less 会使用 ~ 作为自己的特殊标识，所以在 Vite 解析的时候，ESM 并不认识 ～ 符号的问题。</p><p><strong>解决方案</strong></p><p>还是通过别名来将所有的 ~ 符号进行删除即可，<a href="https://github.com/vitejs/vite/issues/2185#issuecomment-784637827" target="_blank" rel="noopener noreferrer">参考文献</a></p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token comment">// ...</span></span>
<span class="line">  <span class="token literal-property property">resolve</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">alias</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">      <span class="token punctuation">{</span> <span class="token literal-property property">find</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^~</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token literal-property property">replacement</span><span class="token operator">:</span> <span class="token string">&#39;&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">]</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token comment">// ...</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="q5-无法识别-global-变量" tabindex="-1"><a class="header-anchor" href="#q5-无法识别-global-变量"><span>Q5： 无法识别 global 变量</span></a></h3><p><img src="https://cdn.jsdelivr.net/gh/0xe69e97/image-PicX@master/Blog/image.1fph7jromqio.png" alt="image"></p><p>在模版页面报的问题，具体是哪个包的问题我忘记了。。这个解决需要手动简单 Hack 一下。</p><p><strong>解决方案</strong></p><p>在 <code>index.html</code> 的 ESM 模块文件之前加入以下代码</p><div class="language-html line-numbers-mode" data-highlighter="prismjs" data-ext="html"><pre><code class="language-html"><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript"></span>
<span class="line">  <span class="token keyword">const</span> global <span class="token operator">=</span> window<span class="token punctuation">;</span></span>
<span class="line"></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>即可解决这个问题。<a href="https://github.com/plouc/nivo/issues/1455#issuecomment-815904731" target="_blank" rel="noopener noreferrer">参考文献</a></p><h3 id="q6-antd-的样式包无法应用" tabindex="-1"><a class="header-anchor" href="#q6-antd-的样式包无法应用"><span>Q6：antd 的样式包无法应用</span></a></h3><p>通过上面的解决之后，现在可以将系统跑起来了，但是页面的样式都已经丢失掉了，已经面目全非了。。应该是样式丢失的问题。接下来处理一下样式</p><p><strong>解决方案</strong></p><ol><li>安装 vite-plugin-imp 插件</li></ol><p><img src="https://cdn.jsdelivr.net/gh/0xe69e97/image-PicX@master/Blog/image.5ipbsfd1rg00.png" alt="image"></p><ol start="2"><li>配置一下插件</li></ol><p><img src="https://cdn.jsdelivr.net/gh/0xe69e97/image-PicX@master/Blog/image.1b17b66y35gg.png" alt="image"></p><p>这样的话，我们的项目应该就可以了，然后继续运行一下。</p><p>发现项目报错了。看一下问题</p><h3 id="q7-无法找到部分-antd-包的样式文件" tabindex="-1"><a class="header-anchor" href="#q7-无法找到部分-antd-包的样式文件"><span>Q7：无法找到部分 antd 包的样式文件</span></a></h3><p><img src="https://cdn.jsdelivr.net/gh/0xe69e97/image-PicX@master/Blog/image.477zq4c0zpy0.png" alt="image"></p><p><strong>解决方案</strong></p><ol><li>查看 node_modules 文件</li><li>对比发现 Row 组件和 Col 组件并没有相关的样式文件</li><li>需要对这两个包进行处理</li></ol><p><img src="https://cdn.jsdelivr.net/gh/0xe69e97/image-PicX@master/Blog/image.3a97emqhf000.png" alt="image"></p><p>直接排斥着两个包，我们给返回空串来解决未找到包的问题。</p><h3 id="q8-配置接口代理" tabindex="-1"><a class="header-anchor" href="#q8-配置接口代理"><span>Q8：配置接口代理</span></a></h3><p>当我们在真正开发项目的时候，在联调阶段，我们需要将本地环境代理到后端 API 上才可以获取到真正的数据，所以需要配置本地的接口代理来访问。</p><p><strong>解决方案</strong></p><ol><li>配置接口代理，本地开发无法代理到测试环境</li><li>类似 Vue-CLI 配置 Proxy 字段</li></ol><p><img src="https://cdn.jsdelivr.net/gh/0xe69e97/image-PicX@master/Blog/image.2b6i4c1865wk.png" alt="image"></p><h3 id="q9-配置接口代理引发的问题" tabindex="-1"><a class="header-anchor" href="#q9-配置接口代理引发的问题"><span>Q9：配置接口代理引发的问题</span></a></h3><p>因为我们项目接口字段不统一，所以需要对所有的接口添加 <code>/api</code> 前缀，来实现所有的接口统一处理。但是通过后端修改的话，成本太高，而且后端不会为了前端一些更改去将整个系统的路径都改一遍，可能会引发未知的问题等。而且其目的是前端提效，并不是在项目上或者收益上有所关联。</p><p>引发的问题如下：</p><ul><li>使用 Webpack 打包时会出现 404 的问题</li><li>不使用 <code>/api</code> 前缀，代理配置将无法配置或极其麻烦</li></ul><p><strong>解决方案</strong></p><ul><li><strong>前端</strong>根据环境变量对全局 API 接口路径进行调整</li><li>对目前打包上线的 API 不做任何的处理</li></ul><p>前端通过注入代码处理</p><p><img src="https://cdn.jsdelivr.net/gh/0xe69e97/image-PicX@master/Blog/image.1wm6kjquormo.png" alt="image"></p><p><img src="https://cdn.jsdelivr.net/gh/0xe69e97/image-PicX@master/Blog/image.2xuv9g7vo5k0.png" alt="image"></p><p>截图中只列出了一个接口的地址，其实每一个模块都是不同的接口地址，例如 <code>/image/...</code> <code>/video/...</code> 等等等等，每一个模块都有自己的专属名称作为开头。所以我们需要通过递归遍历的模式来进行添加接口前缀。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> newPaths <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> paths<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> paths<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    newPaths<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">addRequestUrlPrefix</span><span class="token punctuation">(</span>paths<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">    newPaths<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;/api&quot;</span> <span class="token operator">+</span> paths<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>而且还需要区分开发环境以及线上环境</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">&quot;development&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token function">convertUrl</span><span class="token punctuation">(</span>paths<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> paths<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>此时我们本地开发的接口都将自动添加 <code>/api</code> 前缀了，而且在通过接口代理的时候，都统一被 Vite 处理掉了</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">  <span class="token literal-property property">proxy</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token string-property property">&#39;/api&#39;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token string">&#39;http://admediatest.58v5.cn&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">changeOrigin</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token function-variable function">rewrite</span><span class="token operator">:</span> <span class="token parameter">path</span> <span class="token operator">=&gt;</span> path<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\/api</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>有的同学可能不知道为什么这样做哈，简单解释一下。如果我们在 <code>rewrite</code> 这里不进行匹配的话，其实我们的前端路由也会被 proxy 给解析出来，所以我们要区分接口和前端路由的路径。所以我们需要这个统一的接口路径来进行区分。</p><p>好了，到这里之后，我们的项目就可以用 Vite 跑起来了，而且可以通过和之前一样的开发流程进行开发即可。就是在 HMR 上的速度有点不适应，有点快～在来看一下我们开头的数据对比</p><table><thead><tr><th style="text-align:center;"></th><th style="text-align:center;">Vite</th><th style="text-align:center;">Webpack</th><th style="text-align:center;">提升倍数</th></tr></thead><tbody><tr><td style="text-align:center;">启动项目</td><td style="text-align:center;">0.5s</td><td style="text-align:center;">33s</td><td style="text-align:center;"><strong>66 倍</strong></td></tr><tr><td style="text-align:center;">首屏</td><td style="text-align:center;">19s</td><td style="text-align:center;">36s</td><td style="text-align:center;">1.9 倍</td></tr><tr><td style="text-align:center;">HMR</td><td style="text-align:center;">0.2s</td><td style="text-align:center;">6s</td><td style="text-align:center;"><strong>30 倍</strong></td></tr></tbody></table><h2 id="个人对-vite-的一些想法" tabindex="-1"><a class="header-anchor" href="#个人对-vite-的一些想法"><span>个人对 Vite 的一些想法</span></a></h2><ol><li>在开发环境，Vite 的优势已经很明显了。完全值得我们去升级，维护</li><li>线上环境的话可以根据自己的需求，其实一起维护两套配置文件也是比较麻烦比较坑的事情～</li><li>目前在 PC 端使用还是比较不错的，不知道在移动端上会有什么差距因为各个浏览器的兼容性在移动端上本来就要比 PC 麻烦的多</li><li>在线上环境也已经算是成熟了，通过对应的插件都可以实现打包成兼容旧浏览器等。</li></ol><h3 id="总结" tabindex="-1"><a class="header-anchor" href="#总结"><span>总结：</span></a></h3><p>目前项目已经在 Vite 模式下平稳运行，在开发阶段已经有了相当大的提升。目前线上还是通过 Webpack 来进行 bundle ，通过上面的实战已经尽最大努力与 Webpack 持平生产和开发环境。在之后还会持续发掘 unbundled 模式。</p><p>Unbundled 开发模式是一个趋势，未来可期～</p></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">最近更新: </span><time class="meta-item-info" datetime="2025-10-11T09:00:34.000Z" data-allow-mismatch>2025/10/11 17:00</time></div><!----></div></footer><!----><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-igEGucXV.js" defer></script>
  </body>
</html>
