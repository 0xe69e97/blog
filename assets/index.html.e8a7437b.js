import{_ as t,d as o,o as c,a as l,b as n,e as a,w as p,F as r,f as e,c as i}from"./app.482c2f46.js";const u={name:"MacTools",data(){return{deployURL:""}}},k={class:"table-of-contents"},b=e("nodejs \u6240\u9700\u7684\u6838\u5FC3\u5E93"),m=e("\u52A8\u624B\u5199 core code"),d=e("\u90AE\u4EF6\u914D\u7F6E"),h=e("WebHooks \u914D\u7F6E"),g=i(`<p>\u{1F60A} \u8FD9\u6B21\u81EA\u5DF1\u5199\u4E86\u4E00\u4E2A\u57FA\u4E8E nodejs \u7684\u81EA\u52A8\u5316\u90E8\u7F72\u7684\u5DE5\u5177\uFF0C\u56E0\u4E3A\u4E4B\u524D\u5728\u7528 jenkins \u7531\u4E8E jenkins \u6BD4\u8F83\u5F3A\u5927\uFF0C\u800C\u4E14\u6BD4\u8F83\u7B28\u91CD\uFF0C\u5BF9\u4E8E\u6211\u6765\u8BF4\u53EA\u662F\u7528\u6765\u90E8\u7F72\u4E00\u4E2A\u524D\u7AEF application \u800C\u5DF2\uFF0C\u6240\u4EE5\u6CA1\u5FC5\u8981\u7528\u8FD9\u6837\u6BD4\u8F83\u5B8C\u5584\u7684\u5DE5\u5177\uFF0C\u6BD5\u7ADF\u670D\u52A1\u5668\u8D44\u6E90\u6709\u9650\u3002\u3002</p><p>\u{1F60B} \u9644\u4E0A\u4E00\u4E2A\u4E4B\u524D\u5199\u7684\u6587\u7AE0 <a href="https://smalin.cn/post/2019/05/27/jenkins/">gitee + webhooks + jenkins \u5B9E\u73B0\u81EA\u52A8\u5316\u90E8\u7F72</a></p><p>\u539F\u7406\u4E0E jenkins \u7C7B\u4F3C\uFF0C\u4E5F\u662F\u53D7\u76CA\u4E8E jenkins \u7684\u542F\u53D1\uFF0C\u81EA\u5DF1\u5199\u4E86\u4E00\u4E2A nodejs \u90E8\u7F72\u5DE5\u5177</p><div class="custom-container tip"><svg viewBox="0 0 25 25" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;"><path d="M297.6 258.73H296c-59.47.87-110.69 51.45-111.83 110.43-.626 36.485 16.525 71.085 45.94 92.68 17.86 13.18 29.88 33.56 33.77 56.42h67.62c4-22.82 16.13-43.3 34.16-56.74 28.589-21.097 45.496-54.587 45.496-90.118 0-30.03-12.078-58.833-33.496-79.882a113.133 113.133 0 0 0-80.06-32.79ZM265.19 550.7v26.6c0 4.84 1.17 6.43 1.17 6.43l63.72-.59V550.7h-64.89Z" style="fill:#48b884;fill-rule:nonzero;" transform="matrix(.042 0 0 .042 0 -5.178)"></path><path d="M297.64 123.3C133.26 123.3 0 256.56 0 420.94s133.26 297.63 297.64 297.63 297.63-133.25 297.63-297.63S462 123.3 297.64 123.3ZM385 487.57c-14.11 10.48-22.51 28.09-22.51 47.14v48.43c-.016 17.792-14.648 32.428-32.44 32.45h-64.86c-15.6 0-32.44-12-32.44-38.29v-42.82c0-19-8.21-36.4-21.93-46.52-37.882-27.85-59.959-72.44-59.14-119.45 1.46-77.24 66-141.09 143.81-142.22 38.87.19 76.89 14.37 105 42.11a143.764 143.764 0 0 1 43.14 103c-.159 45.761-21.911 88.86-58.63 116.17Z" style="fill:#48b884;fill-rule:nonzero;" transform="matrix(.042 0 0 .042 0 -5.178)"></path></svg><p class="custom-container-title">TIP</p><ul><li>\u672C\u6B21\u4ED3\u5E93\u73AF\u5883\u662F gitee \uFF0C\u4F46\u662F\u53EA\u8981\u6709 webhooks \u5C31\u90FD\u53EF\u4EE5\u90E8\u7F72</li><li>gitlab \u6709\u81EA\u5DF1\u7684 <a href="https://docs.gitlab.com/ee/ci/" target="_blank" rel="noopener noreferrer">gitlab CI</a> \u5F88\u4E0D\u9519\u7684</li><li>github \u4E5F\u6709 <a href="https://travis-ci.org/" target="_blank" rel="noopener noreferrer">travis-ci</a> \u7B49\u7B49\u5F00\u6E90\u81EA\u52A8\u5316\u90E8\u7F72\u5DE5\u5177</li></ul></div><h2 id="nodejs-\u6240\u9700\u7684\u6838\u5FC3\u5E93" tabindex="-1"><a class="header-anchor" href="#nodejs-\u6240\u9700\u7684\u6838\u5FC3\u5E93" aria-hidden="true">#</a> nodejs \u6240\u9700\u7684\u6838\u5FC3\u5E93</h2><p>\u{1F643} \u7531\u4E8E\u672C\u4EBA\u6BD4\u8F83\u61D2\uFF0C\u7528\u4E86 <a href="https://koa.bootcss.com/" target="_blank" rel="noopener noreferrer">koa</a></p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// koa</span>
<span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;koa&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// koa-router</span>
<span class="token keyword">const</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;koa-router&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// \u5B9E\u4F8B\u5316 koa</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// \u5B9E\u4F8B\u5316 koa-router</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// \u662F child process \u7684\u5C01\u88C5</span>
<span class="token keyword">const</span> shell <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;shelljs&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// \u57FA\u4E8E nodejs \u5B9E\u73B0\u7684\u81EA\u52A8\u53D1\u90AE\u4EF6</span>
<span class="token keyword">const</span> nodemailer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;nodemailer&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// get response body lib</span>
<span class="token keyword">const</span> bodyParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;koa-bodyparser&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// \u90AE\u4EF6\u914D\u7F6E</span>
<span class="token keyword">let</span> transporter <span class="token operator">=</span> nodemailer<span class="token punctuation">.</span><span class="token function">createTransport</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">host</span><span class="token operator">:</span> <span class="token string">&#39;smtp.exmail.qq.com&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token number">465</span><span class="token punctuation">,</span> <span class="token comment">// SMTP \u7AEF\u53E3</span>
  <span class="token literal-property property">secureConnection</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// \u4F7F\u7528\u4E86 SSL</span>
  <span class="token literal-property property">auth</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">user</span><span class="token operator">:</span> <span class="token string">&#39;\u4F60\u8981\u53D1\u9001 email \u7684\u5730\u5740&#39;</span><span class="token punctuation">,</span>
    <span class="token comment">// smtp\u6388\u6743\u7801</span>
    <span class="token literal-property property">pass</span><span class="token operator">:</span> <span class="token string">&#39;\u6388\u6743\u7801\uFF0C\u4E0D\u662F\u5BC6\u7801&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h2 id="\u52A8\u624B\u5199-core-code" tabindex="-1"><a class="header-anchor" href="#\u52A8\u624B\u5199-core-code" aria-hidden="true">#</a> \u52A8\u624B\u5199 core code</h2><p>\u7136\u540E\u5F00\u59CB\u5199\u81EA\u52A8\u90E8\u7F72\u7684\u63A5\u53E3</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#39;/deploy-application&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// \u8BBE\u7F6E\u8DE8\u57DF</span>
  ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;Access-Control-Allow-Origin&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;*&#39;</span><span class="token punctuation">)</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">&#39;ok&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
    <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token string">&#39;success&#39;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ul><li>\u63A5\u53E3\u53EF\u4EE5\u901A\u4E86\uFF0C\u8FD9\u6B21\u53EF\u4EE5\u5F00\u59CB\u5199 core code \u4E86</li><li>\u9996\u5148\u62FF\u5230 webhooks \u53D1\u9001\u7684 post \u8BF7\u6C42\u7684\u53C2\u6570</li><li>\u5C06\u5206\u652F\u5355\u72EC\u62FF\u51FA\u6765\uFF0C\u6BD5\u7ADF\u4E00\u4E2A\u4ED3\u5E93\u597D\u51E0\u4E2A\u5206\u652F\u5462</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> requestBranch <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">.</span>ref
<span class="token keyword">const</span> requestBranchLength <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">.</span>ref<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>
<span class="token keyword">const</span> branch <span class="token operator">=</span> requestBranch<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>requestBranchLength<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>\u5206\u652F\u53D6\u5230\u4E4B\u540E\uFF0C\u53EF\u4EE5\u8FDB\u884C\u5224\u65AD\u4E86\uFF0C\u5148\u7528\u5F00\u53D1\u5206\u652F\u6765\u8FDB\u884C\u64CD\u4F5C</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>branch <span class="token operator">===</span> <span class="token string">&#39;develop&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// \u5F00\u53D1\u73AF\u5883\u90E8\u7F72</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">&#39;ok&#39;</span>
  shell<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">&#39;yarn run deploy&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>\u7136\u540E\u7528 shell js \u6267\u884C\u4E00\u4E2A <code>.sh</code> \u6587\u4EF6</li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u786E\u4FDD\u629B\u9519</span>
<span class="token builtin class-name">set</span> -e

<span class="token assign-left variable">REF</span><span class="token operator">=</span><span class="token string">&quot;\u4F60\u7684 git \u4ED3\u5E93\u5730\u5740&quot;</span>
<span class="token assign-left variable">FOLDER</span><span class="token operator">=</span><span class="token string">&quot;clone \u8FDC\u7A0B\u4ED3\u5E93\u4E0B\u6765\u7684\u6587\u4EF6\u5939\u4F4D\u7F6E&quot;</span>
<span class="token assign-left variable">DEPLOY_FOLDER</span><span class="token operator">=</span><span class="token string">&quot;\u4F60\u8981\u90E8\u7F72\u5230\u670D\u52A1\u5668\u7684\u6587\u4EF6\u5939\u4F4D\u7F6E&quot;</span>

<span class="token function">rm</span> -rf <span class="token variable">\${FOLDER}</span>

<span class="token function">git</span> clone -b develop <span class="token variable">\${REF}</span> <span class="token variable">\${FOLDER}</span>

<span class="token builtin class-name">cd</span> <span class="token variable">\${FOLDER}</span>

<span class="token function">yarn</span> <span class="token function">install</span>

<span class="token function">yarn</span> run build:develop

<span class="token function">rm</span> -rf <span class="token variable">\${DEPLOY_FOLDER}</span>

<span class="token function">cp</span> -R <span class="token variable">\${FOLDER}</span>dist/<span class="token variable">\${DEPLOY_FOLDER}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h2 id="\u90AE\u4EF6\u914D\u7F6E" tabindex="-1"><a class="header-anchor" href="#\u90AE\u4EF6\u914D\u7F6E" aria-hidden="true">#</a> \u90AE\u4EF6\u914D\u7F6E</h2><ul><li>\u6700\u540E\u914D\u7F6E\u4E00\u4E0B\u90AE\u4EF6\u7CFB\u7EDF\uFF08\u53EF\u9009\uFF09</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">let</span> mailOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">from</span><span class="token operator">:</span> <span class="token string">&#39;&quot;\u4F60\u7684\u90AE\u4EF6&quot; &lt;\u4F60\u7684\u90AE\u4EF6&gt;&#39;</span><span class="token punctuation">,</span> <span class="token comment">// sender address</span>
  <span class="token literal-property property">to</span><span class="token operator">:</span> <span class="token string">&#39;\u8981\u63A5\u53D7\u4EBA\u7684\u90AE\u4EF6&#39;</span><span class="token punctuation">,</span> <span class="token comment">// list of receivers</span>
  <span class="token literal-property property">subject</span><span class="token operator">:</span> <span class="token string">&#39;\u3010\u9879\u76EE\u3011\u90E8\u7F72\u90AE\u4EF6&#39;</span><span class="token punctuation">,</span> <span class="token comment">// Subject line</span>
  <span class="token literal-property property">html</span><span class="token operator">:</span> <span class="token string">&#39;&lt;b&gt;\u9879\u76EE\u5DF2\u7ECF\u90E8\u7F72\u81F3&lt;a href=&quot;http://xxxx&quot;&gt;http://xxx&lt;/a&gt;&lt;/b&gt;&#39;</span> <span class="token comment">// html body</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
transporter<span class="token punctuation">.</span><span class="token function">sendMail</span><span class="token punctuation">(</span>mailOptions<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> info</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;Message sent: %s&#39;</span><span class="token punctuation">,</span> info<span class="token punctuation">.</span>messageId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ul><li>\u6700\u540E\u542F\u52A8\u4E00\u4E0B\u5B50\u670D\u52A1\u5668</li><li>http://server.com:3000</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>app
  <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">bodyParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">allowedMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="webhooks-\u914D\u7F6E" tabindex="-1"><a class="header-anchor" href="#webhooks-\u914D\u7F6E" aria-hidden="true">#</a> WebHooks \u914D\u7F6E</h2><p>\u53EF\u4EE5\u53BB\u53C2\u8003\u4E00\u4E0B <a href="https://smalin.cn/post/2019/05/27/jenkins/">gitee + WebHooks + jenkins \u5B9E\u73B0\u81EA\u52A8\u5316\u90E8\u7F72\uFF0C\u914D\u7F6E WebHooks</a></p>`,23);function f(v,y,j,x,w,_){const s=o("RouterLink");return c(),l(r,null,[n("nav",k,[n("ul",null,[n("li",null,[a(s,{to:"#nodejs-\u6240\u9700\u7684\u6838\u5FC3\u5E93"},{default:p(()=>[b]),_:1})]),n("li",null,[a(s,{to:"#\u52A8\u624B\u5199-core-code"},{default:p(()=>[m]),_:1})]),n("li",null,[a(s,{to:"#\u90AE\u4EF6\u914D\u7F6E"},{default:p(()=>[d]),_:1})]),n("li",null,[a(s,{to:"#webhooks-\u914D\u7F6E"},{default:p(()=>[h]),_:1})])])]),g],64)}var L=t(u,[["render",f]]);export{L as default};
